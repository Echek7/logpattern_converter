name: CI / E2E / Deploy (staging)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  FIREBASE_PROJECT: logpattern-pro-999c8
  E2E_SCRIPT_PATH: .\scripts\e2e_test.ps1

jobs:
  build-test-e2e-deploy:
    name: Test ▶ E2E (Windows) ▶ Deploy (GCP)
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node (for firebase-tools)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install repo dev deps (pip)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Asegura que pytest esté disponible en el runner
          pip install pytest
          # Instala resto de dependencias si existe requirements.txt
          if (Test-Path "requirements.txt") { pip install -r requirements.txt } else { Write-Output "No requirements.txt found; continuing..." }

      - name: Run unit tests (pytest)
        shell: pwsh
        run: |
          Write-Output "Running pytest: will try ./tests then ./test (if present)."
          $paths = @("tests","test")
          $ranAny = $false
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Output "Attempting pytest on path: $p"
              python -m pytest $p -q
              $code = $LASTEXITCODE
              if ($code -eq 0) {
                Write-Output "PYTEST OK on $p"
                $ranAny = $true
                break
              } elseif ($code -eq 5) {
                Write-Output "PYTEST: No tests collected in $p (exit code 5). Trying next path."
                continue
              } else {
                Write-Error "PYTEST failed on $p with exit code $code"
                exit $code
              }
            } else {
              Write-Output "Path not found: $p"
            }
          }
          if (-not $ranAny) {
            Write-Output "PYTEST: No tests collected in any path. Continuing pipeline (not a hard failure)."
          }

      - name: Prepare Windows PowerShell execution policy
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Ensure scripts folder exists
        run: |
          if (-not (Test-Path ".\scripts\e2e_test.ps1")) { Write-Error "E2E script not found at .\scripts\e2e_test.ps1 - aborting"; exit 1 }

      - name: Install Stripe CLI (choco)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install stripe -y
          stripe --version

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project
        run: |
          gcloud config set project $Env:FIREBASE_PROJECT

      - name: Install firebase-tools
        run: |
          npm install -g firebase-tools@14

      - name: Map required secret envvars for local E2E (set from repo secrets)
        shell: pwsh
        run: |
          # Mapear secrets al entorno para el script E2E
          $Env:STRIPE_TEST_KEY = "${{ secrets.STRIPE_TEST_KEY }}"
          $Env:STRIPE_WEBHOOK_FORWARD_URL = "${{ secrets.STRIPE_WEBHOOK_FORWARD_URL }}"
          $Env:GCP_SA_KEY = "${{ secrets.GCP_SA_KEY }}"
          $Env:FIREBASE_PROJECT = "${{ env.FIREBASE_PROJECT }}"
          $Env:PRICE_ID = "${{ secrets.PRICE_ID }}"
          $Env:SENDGRID_API_KEY = "${{ secrets.SENDGRID_API_KEY }}"

      - name: Run E2E (PowerShell)
        shell: pwsh
        run: |
          Write-Output "Running E2E script: $Env:GITHUB_WORKSPACE\$Env:E2E_SCRIPT_PATH"
          .\scripts\e2e_test.ps1

      - name: Deploy Cloud Functions (staging/project)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --only functions --project $Env:FIREBASE_PROJECT --force
