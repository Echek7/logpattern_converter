name: CI / E2E / Deploy (staging)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  FIREBASE_PROJECT: logpattern-pro-999c8
  E2E_SCRIPT_PATH: .\scripts\e2e_test.ps1

jobs:
  build-test-e2e-deploy:
    name: Test ▶ E2E (Windows) ▶ Deploy (GCP)
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node (for firebase-tools)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install repo dev deps (pip)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Output "No requirements.txt found; continuing..."
          }

      - name: Run unit tests (pytest)
        shell: pwsh
        run: |
          Write-Output "Running pytest (tests/test optional)"
          $paths = @("tests","test")
          foreach ($p in $paths) {
            if (Test-Path $p) {
              python -m pytest $p -q
              if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 5) {
                exit 0
              } else {
                exit $LASTEXITCODE
              }
            }
          }
          Write-Output "No tests found. Continuing."

      - name: Prepare PowerShell execution policy
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Ensure E2E script exists
        shell: pwsh
        run: |
          if (-not (Test-Path ".\scripts\e2e_test.ps1")) {
            Write-Error "E2E script not found"
            exit 1
          }

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project
        run: |
          gcloud config set project $Env:FIREBASE_PROJECT

      - name: Install firebase-tools
        run: |
          npm install -g firebase-tools@14

      - name: Map secrets for E2E
        shell: pwsh
        run: |
          $Env:STRIPE_TEST_KEY = "${{ secrets.STRIPE_TEST_KEY }}"
          $Env:GCP_SA_KEY = "${{ secrets.GCP_SA_KEY }}"
          $Env:FIREBASE_PROJECT = "${{ env.FIREBASE_PROJECT }}"
          $Env:PRICE_ID = "${{ secrets.PRICE_ID }}"
          $Env:SENDGRID_API_KEY = "${{ secrets.SENDGRID_API_KEY }}"

      - name: Run E2E
        shell: pwsh
        run: |
          .\scripts\e2e_test.ps1

      - name: Deploy Cloud Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --only functions --project $Env:FIREBASE_PROJECT --force
