name: CI / E2E / Deploy (staging)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  FIREBASE_PROJECT: logpattern-pro-999c8
  E2E_SCRIPT_PATH: .\scripts\e2e_test.ps1

jobs:
  build-test-e2e-deploy:
    name: Test â–¶ E2E (Windows) â–¶ Deploy (GCP)
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node (for firebase-tools)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install repo dev deps (pip)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Output "No requirements.txt found; continuing..."
          }

      - name: Run unit tests (pytest)
        shell: pwsh
        run: |
          $paths = @("tests","test")
          $ranAny = $false
          foreach ($p in $paths) {
            if (Test-Path $p) {
              python -m pytest $p -q
              $code = $LASTEXITCODE
              if ($code -eq 0) { $ranAny = $true; break }
              elseif ($code -ne 5) { exit $code }
            }
          }
          if (-not $ranAny) {
            Write-Output "No tests collected. Continuing."
          }

      - name: Prepare PowerShell execution policy
        shell: pwsh
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Ensure E2E script exists
        shell: pwsh
        run: |
          if (-not (Test-Path ".\scripts\e2e_test.ps1")) {
            Write-Error "E2E script not found"
            exit 1
          }

      # ðŸ”¥ ESTE ERA EL PASO QUE FALTABA ðŸ”¥
      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.FIREBASE_PROJECT }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project
        shell: pwsh
        run: |
          gcloud config set project $Env:FIREBASE_PROJECT
          gcloud --version

      - name: Install firebase-tools
        shell: pwsh
        run: |
          npm install -g firebase-tools@14

      - name: Map secret env vars for E2E
        shell: pwsh
        run: |
          $Env:STRIPE_TEST_KEY = "${{ secrets.STRIPE_TEST_KEY }}"
          $Env:STRIPE_WEBHOOK_FORWARD_URL = "${{ secrets.STRIPE_WEBHOOK_FORWARD_URL }}"
          $Env:PRICE_ID = "${{ secrets.PRICE_ID }}"
          $Env:SENDGRID_API_KEY = "${{ secrets.SENDGRID_API_KEY }}"

      - name: Run E2E
        shell: pwsh
        run: |
          .\scripts\e2e_test.ps1

      - name: Deploy Cloud Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        shell: pwsh
        run: |
          firebase deploy --only functions --project $Env:FIREBASE_PROJECT --force
